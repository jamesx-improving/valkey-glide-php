name: Install and test PIE package

permissions:
  contents: read

on:
  push: {}
  pull_request: {}
  workflow_dispatch:
    inputs:
      full-matrix:
        description: "Run the full engine, host, and language version matrix"
        type: boolean
        default: false

jobs:
  get-matrices:
    runs-on: ubuntu-latest
    outputs:
      engine-matrix-output: ${{ steps.get-matrices.outputs.engine-matrix-output }}
      host-matrix-output: ${{ steps.get-matrices.outputs.host-matrix-output }}
      version-matrix-output: ${{ steps.get-matrices.outputs.version-matrix-output }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - id: get-matrices
        uses: ./.github/workflows/create-test-matrices
        with:
          language-name: php
          # Run full test matrix if job started by cron or it was explicitly specified by a person who triggered the workflow
          run-full-matrix: ${{ github.event.inputs.full-matrix == 'true' || github.event_name == 'schedule' }}

  test-pie-install:
    name: PHP Tests - ${{ matrix.php }}, EngineVersion - ${{ matrix.engine.version }}, Target - ${{ matrix.host.TARGET }}
    needs: get-matrices
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJson(needs.get-matrices.outputs.version-matrix-output) }}
        engine: ${{ fromJson(needs.get-matrices.outputs.engine-matrix-output) }}
        host: ${{ fromJson(needs.get-matrices.outputs.host-matrix-output) }}
    runs-on: ${{ matrix.host.RUNNER }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Output Matrix Parameters for this job
        run: |
          echo "Job running with the following matrix configuration:"
          echo "${{ toJson(matrix) }}"

      - name: Setup PHP Extension Build Environment
        uses: ./.github/workflows/setup-php-extension
        with:
          php-version: ${{ matrix.php }}
          install-composer-deps: "true"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manual Composer repository
        run: |
          mkdir -p web

          # Determine the correct repository URL and reference for PRs vs direct pushes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            REPO_URL="${{ github.event.pull_request.head.repo.clone_url }}"
            REPO_REF="${{ github.event.pull_request.head.sha }}"
            echo "Using PR head repository: $REPO_URL at $REPO_REF"
          else
            REPO_URL="${{ github.server_url }}/${{ github.repository }}"
            REPO_REF="${{ github.sha }}"
            echo "Using main repository: $REPO_URL at $REPO_REF"
          fi

          # Create packages.json manually
          cat > web/packages.json << EOF
          {
            "packages": {
              "valkey-io/valkey-glide-php": {
                "1.0.0": {
                  "name": "valkey-io/valkey-glide-php",
                  "version": "1.0.0",
                  "version_normalized": "1.0.0.0",
                  "source": {
                    "type": "git",
                    "url": "$REPO_URL",
                    "reference": "$REPO_REF"
                  },
                  "type": "php-ext",
                  "php-ext": {
                    "extension-name": "valkey_glide"
                  },
                  "description": "Valkey GLIDE PHP Extension",
                  "provide": {
                    "ext-valkey_glide": "*"
                  },
                  "require": {
                    "php": ">=8.1"
                  }
                }
              }
            }
          }
          EOF

          # Start HTTP server
          cd web && python3 -m http.server 8000 &
          echo $! > ../server.pid
          sleep 3

      - name: Setup sccache for cross-user Rust caching
        run: |
          echo "=== Setting up sccache for cross-user Rust compilation caching ==="

          # Install sccache
          curl -L https://github.com/mozilla/sccache/releases/download/v0.7.4/sccache-v0.7.4-x86_64-unknown-linux-musl.tar.gz | tar xz
          sudo mv sccache-v0.7.4-x86_64-unknown-linux-musl/sccache /usr/local/bin/
          sudo chmod +x /usr/local/bin/sccache

          # Set up sccache environment for all users
          echo 'export RUSTC_WRAPPER=sccache' | sudo tee /etc/profile.d/sccache.sh
          echo 'export SCCACHE_DIR=/opt/sccache' | sudo tee -a /etc/profile.d/sccache.sh
          sudo chmod +x /etc/profile.d/sccache.sh

          # Create sccache directory accessible to all users
          sudo mkdir -p /opt/sccache
          sudo chmod 777 /opt/sccache

          # Set environment for current session
          export RUSTC_WRAPPER=sccache
          export SCCACHE_DIR=/opt/sccache

          echo "sccache setup complete"

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            valkey-glide/ffi
            valkey-glide/glide-core
          key: pie

      - name: Setup Cargo cache for root user
        run: |
          echo "=== Setting up Cargo cache for root user ==="
          # Copy Cargo cache to root's home directory so PIE can use it
          sudo mkdir -p /root/.cargo
          if [ -d "$HOME/.cargo/registry" ]; then
            echo "Copying Cargo registry cache to root..."
            sudo cp -r "$HOME/.cargo/registry" /root/.cargo/ || echo "Failed to copy registry cache"
          fi
          if [ -d "$HOME/.cargo/git" ]; then
            echo "Copying Cargo git cache to root..."
            sudo cp -r "$HOME/.cargo/git" /root/.cargo/ || echo "Failed to copy git cache"
          fi

          # Set up shared target directory for compiled dependencies
          echo "=== Setting up shared compilation cache for PIE ==="

          # Create a shared target directory that root can access
          sudo mkdir -p /opt/cargo-target
          sudo chmod 755 /opt/cargo-target

          # Copy existing compiled dependencies (not our project code)
          if [ -d "valkey-glide/ffi/target/release/deps" ]; then
            echo "Copying compiled dependencies..."
            sudo mkdir -p /opt/cargo-target/release
            sudo cp -r valkey-glide/ffi/target/release/deps /opt/cargo-target/release/
            sudo chmod -R 755 /opt/cargo-target/release/deps
          fi

          # Set CARGO_TARGET_DIR for all processes
          echo 'export CARGO_TARGET_DIR=/opt/cargo-target' | sudo tee /etc/profile.d/cargo.sh
          echo 'export CARGO_HOME=/root/.cargo' | sudo tee -a /etc/profile.d/cargo.sh
          echo 'export PATH="/root/.cargo/bin:$PATH"' | sudo tee -a /etc/profile.d/cargo.sh
          sudo chmod +x /etc/profile.d/cargo.sh

          echo "Shared compilation cache setup complete"

      - name: Test PIE with manual repository
        run: |
          # Allow HTTP for localhost for both user and root
          composer config --global secure-http false
          sudo composer config --global secure-http false

          # Initialize composer config directories and fix permissions
          mkdir -p "$HOME/.config/composer"
          sudo mkdir -p /root/.config/composer

          # Make sure root can read the user's composer config
          sudo chmod -R 755 "$HOME/.config/composer"
          if [[ "${{ matrix.host.OS }}" == "macos" ]]; then
            sudo chown -R root:wheel "$HOME/.config/composer" || true
          else
            sudo chown -R root:root "$HOME/.config/composer" || true
          fi

          # Add local repository
          pie repository:add composer http://localhost:8000

          echo "=== Attempting PIE installation with verbose output ==="
          set +e
          export CARGO_BUILD_JOBS=$(nproc)
          # Make Rust available to root by preserving environment
          sudo -E env "PATH=$PATH" "CARGO_BUILD_JOBS=$(nproc)" pie install valkey-io/valkey-glide-php:1.0.0 --force --no-interaction -vvv 2>&1 | tee pie_install.log
          PIE_EXIT_CODE=$?
          set -e

          echo "=== PIE exit code: $PIE_EXIT_CODE ==="
          echo "=== PIE log content ==="
          cat pie_install.log || echo "No PIE log found"

          # Check if .so file was built regardless of exit code
          echo "=== Checking if extension was built ==="
          PIE_WORK_DIR=$(find "$HOME/.config/pie" -name "valkey-glide-php" -type d | head -1)
          if [ -n "$PIE_WORK_DIR" ]; then
            echo "PIE working directory: $PIE_WORK_DIR"
            find "$PIE_WORK_DIR" -name "*.so" -type f 2>/dev/null && echo "SUCCESS: .so file was built!" || echo "No .so files found - build failed"
            find "$PIE_WORK_DIR" -name "valkey_glide*" -type f 2>/dev/null | head -5 || echo "No valkey_glide files found"
            echo "=== Contents of modules directory ==="
            ls -la "$PIE_WORK_DIR/modules/" 2>/dev/null || echo "No modules directory"
            echo "=== Contents of .libs directory ==="
            ls -la "$PIE_WORK_DIR/.libs/" 2>/dev/null || echo "No .libs directory"
          fi

          if [ $PIE_EXIT_CODE -eq 0 ]; then
            echo "=== PIE installation completed successfully ==="
            echo "=== Shared object file location ==="
            if [ -n "$PIE_WORK_DIR" ]; then
              SO_FILE=$(find "$PIE_WORK_DIR" -name "valkey_glide.so" -type f 2>/dev/null | head -1)
              if [ -n "$SO_FILE" ]; then
                echo "SUCCESS: Shared object built at: $SO_FILE"
                ls -la "$SO_FILE"
                echo "File size: $(if [[ "${{ matrix.host.OS }}" == "macos" ]]; then stat -f%z "$SO_FILE" 2>/dev/null; else stat -c%s "$SO_FILE" 2>/dev/null; fi || echo "unknown") bytes"
              else
                echo "WARNING: PIE reported success but valkey_glide.so not found"
                find "$PIE_WORK_DIR" -name "*.so" -type f 2>/dev/null || echo "No .so files found at all"
              fi
            fi
          else
            echo "=== PIE installation failed or had errors, showing debugging ==="

            echo "=== Checking makefile debug log ==="
            cat /tmp/makefile_debug.log 2>/dev/null || echo "No makefile debug log found"

            echo "=== PIE working directory contents ==="
            PIE_WORK_DIR=$(find "$HOME/.config/pie" -name "valkey-glide-php" -type d | head -1)
            if [ -n "$PIE_WORK_DIR" ]; then
              echo "PIE working directory: $PIE_WORK_DIR"
              cd "$PIE_WORK_DIR"
              ls -la
              echo "=== Generated Makefile targets ==="
              grep "^[a-zA-Z].*:" Makefile | head -10 2>/dev/null || echo "No Makefile found"
              echo "=== Checking if Makefile.frag was included ==="
              grep -A10 -B5 "Platform-specific configuration\|VALKEY_GLIDE_SHARED_LIBADD" Makefile 2>/dev/null || echo "Makefile.frag content not found in Makefile"
              echo "=== Full Makefile.frag content ==="
              cat Makefile.frag 2>/dev/null || echo "Cannot read Makefile.frag"
              echo "=== valkey-glide directory contents ==="
              ls -la valkey-glide/ 2>/dev/null || echo "valkey-glide directory not found"
              echo "=== .gitmodules file ==="
              cat .gitmodules 2>/dev/null || echo ".gitmodules not found"
              echo "=== git submodule status ==="
              git submodule status 2>/dev/null || echo "git submodule status failed"
              echo "=== valkey-glide/ffi directory ==="
              ls -la valkey-glide/ffi/ 2>/dev/null || echo "ffi directory not found"
              echo "=== target directory ==="
              ls -la valkey-glide/ffi/target/ 2>/dev/null || echo "target directory not found"
              echo "=== Rust build artifacts ==="
              find valkey-glide/ffi/target -name "*.h" 2>/dev/null | head -10 || echo "No Rust build artifacts found"
            fi
          fi

      - name: Verify PIE installation
        run: |
          echo "=== Checking PHP extension directory ==="
          php-config --extension-dir
          ls -la $(php-config --extension-dir) | grep valkey || echo "valkey_glide.so not found in extension directory"

          echo "=== Looking for built extension in PIE working directory ==="
          PIE_WORK_DIR=$(find "$HOME/.config/pie" -name "valkey-glide-php" -type d | head -1)
          if [ -n "$PIE_WORK_DIR" ]; then
            echo "PIE working directory: $PIE_WORK_DIR"
            find "$PIE_WORK_DIR" -name "*.so" -type f 2>/dev/null || echo "No .so files found in PIE directory"
            find "$PIE_WORK_DIR" -name "valkey_glide*" -type f 2>/dev/null || echo "No valkey_glide files found"

            # Check if extension was built but not installed
            SO_FILE=$(find "$PIE_WORK_DIR" -name "valkey_glide.so" -type f 2>/dev/null | head -1)
            if [ -n "$SO_FILE" ]; then
              echo "Extension was built at: $SO_FILE"
              echo "But PIE failed to install it to: $(php-config --extension-dir)"
              echo "=== Checking PIE install log for 'make install' ==="
              grep -i "make install\|install.*valkey\|copying.*valkey" pie_install.log || echo "No 'make install' found in PIE log"
              echo "=== This indicates PIE build succeeded but install step failed ==="
            else
              echo "Extension was not built - build step failed"
            fi
          fi

          echo "=== Checking if extension is loaded ==="
          php -m | grep -i valkey || echo "valkey extension not loaded"

          echo "=== Checking PHP configuration ==="
          php --ini

          echo "=== Manually enabling extension ==="
          php -d extension=valkey_glide -m | grep -i valkey && echo "Extension works when manually enabled!" || echo "Extension still not working"

          echo "=== Testing extension functionality ==="
          php -d extension=valkey_glide -r "if (extension_loaded('valkey_glide')) { echo 'SUCCESS: Extension loaded and functional!'; } else { echo 'ERROR: Extension not functional'; }"

      - name: Run PHP Extension Tests
        uses: ./.github/workflows/run-php-tests
        with:
          extension-path: valkey_glide
          php-version: ${{ matrix.php }}

      - name: Cleanup
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi
